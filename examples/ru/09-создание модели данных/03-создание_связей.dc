# –ü—Ä–∏–º–µ—Ä 3: –°–æ–∑–¥–∞–Ω–∏–µ —Å–≤—è–∑–µ–π –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏
# –î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç, –∫–∞–∫ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–≤—è–∑–∏ –º–µ–∂–¥—É –∫–æ–ª–æ–Ω–∫–∞–º–∏ —Ç–∞–±–ª–∏—Ü —Å –ø–æ–º–æ—â—å—é relate()

print("============================================================")
print("–ü—Ä–∏–º–µ—Ä 3: –°–æ–∑–¥–∞–Ω–∏–µ —Å–≤—è–∑–µ–π –º–µ–∂–¥—É —Ç–∞–±–ª–∏—Ü–∞–º–∏")
print("============================================================")
print()

# –ü—Ä–∏–º–µ—Ä 3.1: –ü—Ä–æ—Å—Ç–∞—è —Å–≤—è–∑—å –º–µ–∂–¥—É –¥–≤—É–º—è —Ç–∞–±–ª–∏—Ü–∞–º–∏
print("üîç –ü—Ä–∏–º–µ—Ä 3.1: –ü—Ä–æ—Å—Ç–∞—è —Å–≤—è–∑—å...")

let products = table([
    ["PROD_001", "Laptop", 999.99],
    ["PROD_002", "Mouse", 29.99],
    ["PROD_003", "Keyboard", 79.99]
], ["product_id", "name", "price"])

let sales = table([
    ["SALE_001", "PROD_001", 2],
    ["SALE_002", "PROD_002", 5],
    ["SALE_003", "PROD_001", 1]
], ["sale_id", "product_id", "quantity"])

print("  –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤: ", len(products), " —Å—Ç—Ä–æ–∫")
print("  –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–¥–∞–∂: ", len(sales), " —Å—Ç—Ä–æ–∫")
print()

# –°–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å –º–µ–∂–¥—É –∫–æ–ª–æ–Ω–∫–∞–º–∏ product_id
try {
    relate(products["product_id"], sales["product_id"])
    print("  ‚úì –°–≤—è–∑—å —Å–æ–∑–¥–∞–Ω–∞: products.product_id ‚Üî sales.product_id")
} catch e {
    print("  ‚úó –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–∏: ", e)
}
print()

# –ü—Ä–∏–º–µ—Ä 3.2: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–≤—è–∑–∏
print("üîç –ü—Ä–∏–º–µ—Ä 3.2: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–≤—è–∑–∏...")

let regions = table([
    ["REG_01", "North", "USA"],
    ["REG_02", "South", "USA"]
], ["region_id", "name", "country"])

let sales_by_region = table([
    ["SALE_001", "REG_01", 1999.98],
    ["SALE_002", "REG_02", 149.95]
], ["sale_id", "region_id", "amount"])

let employees = table([
    ["EMP_001", "Alice", "REG_01"],
    ["EMP_002", "Bob", "REG_02"]
], ["employee_id", "name", "region_id"])

print("  –¢–∞–±–ª–∏—Ü–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤: ", len(regions), " —Å—Ç—Ä–æ–∫")
print("  –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ–¥–∞–∂ –ø–æ —Ä–µ–≥–∏–æ–Ω–∞–º: ", len(sales_by_region), " —Å—Ç—Ä–æ–∫")
print("  –¢–∞–±–ª–∏—Ü–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: ", len(employees), " —Å—Ç—Ä–æ–∫")
print()

# –°–æ–∑–¥–∞—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–≤—è–∑–∏
let relations_created = 0

try {
    relate(regions["region_id"], sales_by_region["region_id"])
    relations_created = relations_created + 1
    print("  ‚úì –°–≤—è–∑—å 1: regions.region_id ‚Üî sales_by_region.region_id")
} catch e {
    print("  ‚úó –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–∏ 1: ", e)
}

try {
    relate(regions["region_id"], employees["region_id"])
    relations_created = relations_created + 1
    print("  ‚úì –°–≤—è–∑—å 2: regions.region_id ‚Üî employees.region_id")
} catch e {
    print("  ‚úó –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–∏ 2: ", e)
}

try {
    relate(sales["sale_id"], sales_by_region["sale_id"])
    relations_created = relations_created + 1
    print("  ‚úì –°–≤—è–∑—å 3: sales.sale_id ‚Üî sales_by_region.sale_id")
} catch e {
    print("  ‚úó –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–∏ 3: ", e)
}

print()
print("  –í—Å–µ–≥–æ —Å–æ–∑–¥–∞–Ω–æ —Å–≤—è–∑–µ–π: ", relations_created)
print()

# –ü—Ä–∏–º–µ—Ä 3.3: –°–≤—è–∑—å –ø–æ—Å–ª–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü
print("üîç –ü—Ä–∏–º–µ—Ä 3.3: –°–æ–∑–¥–∞–Ω–∏–µ —Å–≤—è–∑–µ–π –ø–æ—Å–ª–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü...")

# –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã —Å –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
let monthly_sales_jan = table([
    ["SALE_JAN_001", "PROD_001", 100.0],
    ["SALE_JAN_002", "PROD_002", 50.0]
], ["sale_id", "product_id", "amount"])

let monthly_sales_feb = table([
    ["SALE_FEB_001", "PROD_001", 120.0],
    ["SALE_FEB_002", "PROD_003", 80.0]
], ["sale_id", "product_id", "amount"])

# –û–±—ä–µ–¥–∏–Ω–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã
let all_monthly_sales = merge_tables([monthly_sales_jan, monthly_sales_feb])

if all_monthly_sales != null {
    print("  ‚úì –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞: ", len(all_monthly_sales), " —Å—Ç—Ä–æ–∫")
    
    # –°–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å —Å –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ–π
    try {
        relate(products["product_id"], all_monthly_sales["product_id"])
        print("  ‚úì –°–≤—è–∑—å —Å–æ–∑–¥–∞–Ω–∞: products.product_id ‚Üî all_monthly_sales.product_id")
    } catch e {
        print("  ‚úó –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–∏: ", e)
    }
}
print()

# –ü—Ä–∏–º–µ—Ä 3.4: –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–µ–π
print("üîç –ü—Ä–∏–º–µ—Ä 3.4: –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–≤—è–∑–µ–π —Å –ø–æ–º–æ—â—å—é –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏...")

fn create_relation_safe(table1, col1, table2, col2, relation_name) {
    try {
        let headers1 = table1.columns
        let headers2 = table2.columns
        
        if col1 in headers1 and col2 in headers2 {
            relate(table1[col1], table2[col2])
            print("    ‚úì ", relation_name)
            return true
        } else {
            print("    ‚ö†Ô∏è  ", relation_name, " - –∫–æ–ª–æ–Ω–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
            return false
        }
    } catch e {
        print("    ‚úó ", relation_name, " - –æ—à–∏–±–∫–∞: ", e)
        return false
    }
}

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
let safe_relations = 0
if create_relation_safe(products, "product_id", sales, "product_id", "products ‚Üî sales") {
    safe_relations = safe_relations + 1
}

print("  –ë–µ–∑–æ–ø–∞—Å–Ω—ã—Ö —Å–≤—è–∑–µ–π —Å–æ–∑–¥–∞–Ω–æ: ", safe_relations)
print()

print("============================================================")
print("‚úÖ –ü—Ä–∏–º–µ—Ä 3 –∑–∞–≤–µ—Ä—à—ë–Ω")
print("============================================================")
print()
print("üí° –°–æ–≤–µ—Ç: –°–≤—è–∑–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö SQLite")
print("   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–ª–∞–≥ --build_model –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ —Ç–∞–±–ª–∏—Ü –∏ —Å–≤—è–∑–µ–π –≤ SQLite")
print()
